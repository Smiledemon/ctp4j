package com.itqy8.framework.startup;

import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;

import org.apache.log4j.PropertyConfigurator;
import org.springframework.context.support.ClassPathXmlApplicationContext;
import org.springframework.data.mongodb.core.MongoTemplate;

import com.ctp.dao.MarketDataDao;
import com.ctp.data.entity.MarketData;
import com.google.common.util.concurrent.AbstractIdleService;
import com.itqy8.framework.util.SpringUtil;

public class BootstrapTest extends AbstractIdleService {

	
	private ClassPathXmlApplicationContext context;
	public static void main(String[] args) {
		try {
			InputStream input = BootstrapTest.class.getClassLoader().getResourceAsStream("config/log4j.properties");
			Properties prop = new Properties();
			prop.load(input);
			PropertyConfigurator.configure(prop);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("ERROR: Unable to load config/log4j.properties");
		}
		BootstrapTest bootstrap = new BootstrapTest();
		bootstrap.startAsync();
		try {
			Object lock = new Object();
			synchronized (lock) {
				while (true) {
					lock.wait();
				}
			}
		} catch (InterruptedException ex) {
			System.err.println("ignoreinterruption");
		}
	}

	@Override
	protected void shutDown() throws Exception {
		context.stop();
		System.out.println("-------------service stopped successfully-------------");
	}
	@Override
	protected void startUp() throws Exception {
		context = new ClassPathXmlApplicationContext("classpath:config/spring/*.xml");
		context.start();
		//
		context.registerShutdownHook();
		MongoTemplate mongoTemplate = (MongoTemplate) SpringUtil.getBean("mongoTemplate");
		MarketDataDao marketDataDao = (MarketDataDao) SpringUtil.getBean("marketDataDao");
		MarketData md = new MarketData();
		md.setInstrumentID("test");
		md.setId(1L);
		marketDataDao.save(md);
		MarketData res = marketDataDao.findOne("test", 1);
		System.out.println(res.getId());
		/*//本期已经过去的毫秒数
		int timePeriod=3000000;
		long time = 1464233415500L;
		long passMillis = time%timePeriod;
		long start = time-passMillis;
		
		System.out.println("current:"+new SimpleDateFormat("yyyyMMddHHmmssSSS").format(new Date(time)));
		System.out.println("start:"+new SimpleDateFormat("yyyyMMddHHmmssSSS").format(new Date(start)));
		System.out.println("passMillis:"+passMillis);
		long end = start+timePeriod;
		Collection<Object> idls = new ArrayList<Object>();
		for(long i=start;i<end;i=i+500){
			idls.add("bu1606:"+i);
		}*/
		
		/*MarketDataDao marketDataDao = (MarketDataDao) SpringUtil.getBean("marketDataDao");
		MarketData md1 = new MarketData();
		md1.setInstrumentID("rb1610");
		md1.setTradingDateTime(5l);
		MarketData md2 = new MarketData();
		md2.setInstrumentID("rb1610");
		md2.setTradingDateTime(3l);
		MarketData md3 = new MarketData();
		md3.setInstrumentID("rb1610");
		md3.setTradingDateTime(6L);
		MarketData md4 = new MarketData();
		md4.setInstrumentID("rb1610");
		md4.setTradingDateTime(2l);
		marketDataDao.addZset(md1);
		marketDataDao.addZset(md2);
		marketDataDao.addZset(md3);
		marketDataDao.addZset(md4);
		
		Set<MarketData> setls = marketDataDao.getList("rb1610", 0, 10);
		for(MarketData m:setls){
			System.out.println(m.getTradingDateTime());
		}*/
		/*JedisConnectionFactory cc = (JedisConnectionFactory) SpringUtil.getBean("jedisConnectionFactory");
		cc.getConnection().flushDb();*/
		/*long zstart = System.currentTimeMillis();
		for(int i=0;i<10000;i++){
			redisTemplate.opsForZSet().add("zsetTest",new MarketData(), i);
		}
		
		System.out.println("向zset中插入1万条数据耗时："+ (System.currentTimeMillis()-zstart));*/
		
		/*long hstart = System.currentTimeMillis();
		
		for(int i=0;i<10000;i++){
			redisTemplate.opsForHash().put("hashTest1", i, i);
		}
		
		System.out.println("向hash中插入1万条数据耗时："+ (System.currentTimeMillis()-hstart));*/
		
		/*long hqstart = System.currentTimeMillis();
		Collection<Object> hashKeys = new ArrayList<Object>();
		for(int i=0;i<10000;i++){
			hashKeys.add(i);
		}
		List<Object> ls = redisTemplate.opsForHash().multiGet("hashTest", hashKeys);
		for(Object o:ls){
			MarketData md = JacksonUtils.jsonToObject((String)o, MarketData.class);
		}
		System.out.println("查询hash 1万条数据耗时："+ (System.currentTimeMillis()-hqstart));
		System.out.println(ls.size());
		
		long zsqstart = System.currentTimeMillis();
		
		Set<TypedTuple<MarketData>> set  = redisTemplate.opsForZSet().rangeByScoreWithScores("zsetTest", 0, 100000);
		
		System.out.println("查询zset 1万条数据耗时："+ (System.currentTimeMillis()-zsqstart));
		
		
		System.out.println(set.size());
		*/
		
		System.out.println("----------------provider service started successfully------------");
	}

}
